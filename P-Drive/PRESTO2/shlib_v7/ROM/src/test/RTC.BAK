/*======================================================================*/
/* File name	: RTC.c							*/
/*----------------------------------------------------------------------*
 *$Header: p:/presto/shlib_v7/rom/src/RCS/rtc.c 1.2 1970/01/01 00:00:00 chimura Exp $
 *$Log: rtc.c $
 * リビジョン 1.2  1970/01/01  00:00:00  chimura
 * 2003/11/12 11:30
 * ishida_localtime(),data(),time()をビッグエンディアン仕様であるＤＭＵｄｅ
 * 使用できるように変更する。
 * 
 * リビジョン 1.1  1970/01/01  00:00:00  sakaguti
 * DMUアプリで使用するRTC関数を追加
 * 
 *----------------------------------------------------------------------*/
/*		(c) Copyright 1997-2001 ISHIDA CO., LTD.		*/
/*		959-1 SHIMOMAGARI RITTO-CHO KURITA-GUN SHIGA JAPAN	*/
/*		Phone +81 775 53-4141					*/
/*----------------------------------------------------------------------*/
#include	<itime.h>
#include	<drive\rtcdrv.h>

/*----------------------------------------------------------------------*/

/* !!! WARNING!!!! BCD変換の再検討が必要 */
#define		toBCD(val)		(val-=6*((val&0xf0)>>4))
#define		fromBCD(val)	(val+=6*(val/10))

typedef unsigned char BYTE;

/*======================================================================*/
/*		rtc_init						*/
/*----------------------------------------------------------------------*/
void rtc_init(void)
{
	_rtc_initialize();
}


struct ishida_tm *
ishida_localtime(const ishida_time_t *clock){
	union {
		ishida_time_t l;
		unsigned short u[2];
	} un;
	static struct ishida_tm tm;

	un.l = *clock;
	tm.tm_sec = (short)((un.u[1]) & 63);
	tm.tm_min = (short)((un.u[1]>>8) & 63);
	tm.tm_hour = (short)((un.u[0]) & 31);
	return &tm;
}


/*======================================================================*/
/*		date							*/
/*----------------------------------------------------------------------*/
/* 説明									*/
/*		現在の日付を取得する。					*/
/*----------------------------------------------------------------------*/
/* 引き数								*/
/*		date_t *pd	: 日付の格納エリア			*/
/*									*/
/* 戻り値								*/
/*		date_t *	: 現在の日付				*/
/*----------------------------------------------------------------------*/
/* ★註★								*/
/*		Critical Session は 244us 以内に完了しなければならない	*/
/*----------------------------------------------------------------------*/

#define	LOOP_MAX (10)

date_t date( date_t *pd )			/* Direct I/O edition */
{
	static int		yy=0,mm=1,dd=1,ww=1;

	rtc_gdate(&yy,&mm,&dd,&ww);

	((BYTE *)pd)[0] = (BYTE)yy;		/* year */
	((BYTE *)pd)[1] = (BYTE)mm;		/* month */
	((BYTE *)pd)[2] = (BYTE)dd;		/* day */
	((BYTE *)pd)[3] = (BYTE)ww;		/* week */

	return ( *pd );
}

/*======================================================================*/
/*		time							*/
/*----------------------------------------------------------------------*/
/* 説明									*/
/*		現在の時刻を取得する。					*/
/*----------------------------------------------------------------------*/
/* 引き数																*/
/*		time_t *pt	: 時刻の格納エリア									*/
/*																		*/
/* 戻り値																*/
/*		time_t *	: 現在の時刻										*/
/*----------------------------------------------------------------------*/
/* ★註★								*/
/*		Critical Session は 244us 以内に完了しなければならない	*/
/*----------------------------------------------------------------------*/
ishida_time_t time( ishida_time_t *pt )		/* Direct I/O edition */
{
	static int		hh=0,mm=0,ss=0;

	rtc_gtime(&hh,&mm,&ss);

	((BYTE *)pt)[0] = (BYTE)0;		/* dummy */
	((BYTE *)pt)[1] = (BYTE)hh;		/* hour */
	((BYTE *)pt)[2] = (BYTE)mm;		/* minute */
	((BYTE *)pt)[3] = (BYTE)ss;		/* second */

	return ( *pt );
}

/*======================================================================*/
/*		sdate							*/
/*----------------------------------------------------------------------*/
/* 説明									*/
/*		日付を設定する。					*/
/*----------------------------------------------------------------------*/
/* 引き数								*/
/*		int year	: 年(int) 註：下二桁のみ		*/
/*		int month	: 月(int)				*/
/*		int day		: 日(int)				*/
/*		int week	: 曜日（日曜日が0）			*/
/*----------------------------------------------------------------------*/
int sdate(int year, int month, int day, int week)
{

	rtc_sdate(year,month,day,week);

	return (0);
}

/*======================================================================*/
/*		stime							*/
/*----------------------------------------------------------------------*/
/* 説明									*/
/*		時刻を設定する。					*/
/*----------------------------------------------------------------------*/
/* 引き数								*/
/*		int hour	: 時(int)				*/
/*		int minute	: 分(int)				*/
/*		int second	: 秒(int)				*/
/*----------------------------------------------------------------------*/
int stime(int hour, int minute, int second)
{

	rtc_stime(hour,minute,second);

	return (0);
}


